\subsection*{Preliminaries}
In this section, we will present the preliminary concepts
used in this Thesis. The aim of this section is to provide the reader
with a review of the main notions which are the basis of future sections
as well as to fix the notion used throughout the Thesis.
Thus, we will start presenting basic concepts such as the standard definition of Petri
nets and we will continue with more technical details such as the addition of time features
to this formal model.


\subsubsection{Notation}
The notation used in this work is the following:

\begin{enumerate}
\item {\bf Numbers}\\
We will denote by $\nnul = \mathbb{N} \cup \{0\}$ the set of nonnegative integers including 0,
and $\rnul$ be the nonnegative real numbers including 0. Obviously, $\mathbb{N}$
and $\mathbb{R}$ mean that zero is excluded from the set. Moreover,
$\nnul^{\infty} = \nnul \cup \left\{\infty \right\}$ is the set of nonnegative natural numbers including $\infty$. 
%Asimismo, denotaremos por $Q$ los n\'{u}meros racionales, y por
%$Q^{+}$ los n\'{u}meros racionales positivos.

\item {\bf Sets and Multisets}\\
We will use the standard delimiters for sets (\{\}) and multisets(\multiset{}). 
As usual, let $A$ be a set and $R\,:\,A \longrightarrow \nnul$, we say 
that $x \in A$ iff $R(x) > 0$.
Moreover, we abuse the notion using $x \in A$ to represent that $x$ is an element of
the multiset $A$. The cardinality of the set $A$
is denoted by $|A|$. Given a set $A$,
${\mathcal B}(A)$ is the set of all finite multisets over $A$.


\item {\bf Relations}\\
Let $X$ be a set, a relation over $X$ is a set $R \subseteq X \times X$. 
The domain (or the set of departure) of $R$, denoted by $dom(R)$, is:
\[dom(R) = \{ x \in X \,|\, \exists
and \in X\,:\, (x,y) \in R \}\]
and the codomain (or the set of destination) of $R$, denoted by $cod(R)$, is:
\[cod(R) = \{ x \in X \,|\, \exists y \in X\,:\,(y,x) \in R\}\]
Given a relation $R$, the {\it reflexive and transitive closure} of $R$, $R^*$, is defined as follows:
\[ R^* = \{ (x,y)\,|\,x=y \,\vee\,
\exists x_1,\ldots,x_n,\,\,(x,x_1)\in R,\ldots,(x_n,y) \in R\}\]
Moreover, the {\it transitive closure} of $R$, $R^+$, is given by:
\[R^+ = \{ (x,y)\,|\,
\exists x_1,\ldots,x_n,\,\,(x,x_1)\in R,\ldots,(x_n,y) \in R\}\]

\item {\bf Vectores}\\
La notaci\'{o}n empleada para representar los vectores
ser\'{a} la usual, mediante tuplas. En el caso de vectores con componentes
en $\nnul$, diremos que $v \geq w$ sii todas las componentes de $v$
son mayores o iguales que las correspondientes de $w$. Adem\'{a}s,
diremos que $v > w$ si $v \geq w$ y $v \neq w$.
\end{enumerate}


\section{Petri nets}

\begin{definition} [(Basic Petri nets)]
An \emph{basic Petri net} (PN) is a triple $N=(P,T,F)$, where $P$ and $T$
are sets and $F$ is a relation defined over $P \,\cup\,T$. Moreover, it has to satisfy
the following constraints:
\begin{enumerate}
\item $P \,\cap \,T = \emptyset$
\item $F \subseteq (P \times T) \,\cup\, (T \times P)$
\item $dom(F) \, \cup \, cod(F) = P \, \cup \, T$
\end{enumerate}

In a Petri net, $P$ is known as the set of \emph{places} of $N$, $T$ 
is the set of {\it transitions} and $F$ is a flow relation between the places in $P$
and the transitions in $T$. This relation is graphically represented by arcs.
In this Thesis, we suppose that the sets $P$ and $T$ are finite. Petri nets
can be graphically represented by means of bipartite graphs (or bigraphs), which
is a graph whose vertices can be divided into two disjoint sets ($P$ and $T$ in this case) such that 
every edge connects an element from $P$ to $T$, and vice versa. In graphical representation, places are drawn
as circles and transitions as rectangles or boxes.  The places 
from which an arc runs to a transition are called the \emph{input places} of the transition, whereas
the places from which an arc runs from the transition are called the \emph{output places}.

Let $X = P\,\cup\,T$ be a set and $x \in X$
an element of this set. The preset of $x$ is
$\precond{x} = \{ y \in X \,|\, (y,x) \in F\}~$, whereas the postset of $x$ 
is defined as $x^{\bullet} = \{ y \in X \,|\, (x,y) \in F\}~$.

A net $N$ is $T$-restricted iff $\precond{t} = t^{\bullet} =
\emptyset\,\,\,\forall t \in T$.
\qed
\end{definition}

\begin{example} Let $N=(P,T,F)$ be a Petri net such that:
\[\begin{array}{l}
P = \{ p_1,\,p_2,\,p_3\}\\
T = \{ t_1,\,t_2\}\\
F = \{ (p_1,t_1),\,(p_2,t_1),\,(t_1,p_3),\,(p_3,t_2)\}
\end{array}\]

This net is depicted in Figure \ref{fig201}.
\end{example}

\begin{figure}
\input{fig26}
\caption{\label{fig201} Example of a basic Petri net.}
\end{figure}

Graphically, places in a Petri net may contain a discrete number of marks called tokens. 

\begin{definition} [(Marking on basic Petri nets)]
Let $N=(P,T,F)$ be a basic Petri net.
The function $M: P \longrightarrow
\nnul$ is called {\it marking of $N$}. Then,
$(P,T,F,M)$ is called a {\it marked Petri net}.
\end{definition}

Any distribution of tokens over the places will represent a configuration of the net called \emph{marking}.
The marking of a Petri net is graphically represented by drawing
in each place as many dots as tokens correspond,
or putting into each place the number of tokens associated with it. 


\begin{example} In the net of Figure \ref{fig201}, we can consider the following marking:
\[ M(p_1) = 1,\,\,\,M(p_2)=1,\,\,\,M(p_3)=0 \]
Its graphical representation is shown in Figure \ref{fig202}.
\end{example}

\begin{figure}
\input{fig27}
\caption{\label{fig202} Example of a marked Petri net.}
\end{figure}

The semantics of a Petri net is defined by the following \emph{firing rule}, which
represents the marking reached after firing a transition.

\begin{definition}[(Enabling rule)]
Let $N=(P,T,F,M)$ a marked Petri net. A transition $t \in T$
se dice que {\it est\'{a} permitida bajo el marcaje M},
lo cual se denota por $M[t\rangle$, si para todo
lugar $p \in P$ tal que $(p,t) \in F$ se verifica $M(p) > 0$.
\end{definition}

\begin{definition}[(Firing rule)]
The \emph{firing} of a transition $t$ enabled by the marking $M$
produces a new marking on the net, $M'$, defined as:
\[M'(p) = M(p) - W_f(p,t) + W_f(t,p)~~~\forall p \in P\]
where $W_f(x) = 1$ if $x \in F$ and $W_f(x) = 0$, $x \not\in F$,
for all $x \in (T \times P) \, \cup \, (P \times T)$.
This is denoted by $M[t\rangle M'$.
\end{definition}

\begin{example} In Figure \ref{fig202}, the firing of the transition $t_1$
creates the marking $M'$:
\[ M'(p_1) = 0,\,\,\,M'(p_2)=0,\,\,\,M'(p_3)=1 \]
\end{example}

\begin{definition} [(Concurrent enabling of transitions)]
Let $N= (P,T,F,M)$ be a marked Petri net and $R \subseteq T$ a subset of transitions of $N$.
The set of transitions $R$ is \emph{concurrently enabled}, denoted by $M [ R \rangle$
iff $M(p) \geq \sum_{t \in R} W_f(p,t),~
\forall p\in P$, where
$W_f(p,t)$ is defined as in the last definition.

We can also extend this definition to multisets, thus allowing
multiple instances of the same transition to be fired in just one step.
In this way, we say that the multiset of transitions $R$ 
is enabled in $M$ iff $M(p)
\geq \sum_{t \in T} W_f(p,t) \cdot R(t)$, $\forall p \in P$.

The firing of the multiset of transitions $R$ in $M$ 
produces the new marking $M'$ of $N$:
\[ M'(p) = M(p) - \sumas{t \in T} (W_f(p,t) - W_f(t,p)) \cdot R(t)\]
This net evolution in just one step is denoted by
$M[ R \rangle M'$.
\end{definition}

\chapter{Extended Petri nets}\label{chapter:extended}
After introducing web services (and their composition) and the possible formal models
that can be used to model and analyse them
we will focus on this chapter in the introduction of the models used in this Thesis. Thus, we
will present the extensions of the basic model of Petri nets stated previously and some properties
that can be analysed. We will recall some notions (marking, firing, enableness and so on) defined in the preceding chapter
and will adapt them to a particular case. This chapter is mainly divided in two parts. On the one hand,
we will focus on the definition of Coloured Petri nets since they are used in the definition of the language BPELRF, whereas
we will define timed-arc Petri nets, in its two variants (discrete and continuous), as they are the basis of the workflow model presented in the
second part of this Thesis.

\begin{definition} [(General Petri nets)]
A general Petri net is a 5-tuple $N=(P,T,F,K,W)$, where:
\begin{enumerate}
\item $(P,T,F)$ is a basic Petri net.
\item $K\,:\,P \longrightarrow \nnul \,\cup\, \{\infty\}$ is a function that
indicates the maximum number of tokens in each place.
\item $W\,:\,F \longrightarrow \nnul^{\infty}$ is a function that indicates
the multiplicity of the arcs ({\it weight of the arcs}).
\end{enumerate}
When the context is clear, we will call them Petri nets. The function $K$
can be ommited if it is infinite for all the places in the net.
%Adem\'{a}s, es
%usual extender la definici\'{o}n de $W$ a todo el universo de
%posibles arcos, haci\'{e}ndola nula para pares
%$(p,t)$ o $(t,p)$ que no est\'{e}n en $F$.
\end{definition}

\begin{definition} [(Firing rule for general Petri nets)]
Let $N=(P,T,F,K,W)$ be a general Petri net.
\begin{enumerate}
\item A function $M\,:\, P \longrightarrow \nnul$ is a marking
$N$ iff $M(p) \leq K(p)$, for all
$p \in P$.
\item A transition $t \in T$ is enabled in $M$, denoted by $M[ t \rangle$,
iff $W(p,t) \leq M(p) \leq K(p) - W(t,p)$, for all $p \in P$.
The firing of $t$ produces the marking $M'$:
$M'(p) = M(p) - W(p,t) + W(t,p)$, para todo $p \in P$.
Again, this evolution is denoted by $M[ t \rangle M'$.
\item A multiset of transitions $R$ is enabled in $M$, written $M [ R \rangle$, if and only if
$M(p) \geq \sum_{t \in T} W(p,t) \cdot R(t)$. The firing of $R$
produces $M'$:
\[ M'(p) = M(p) - \sum_{t \in T} (W(p,t) - W(t,p)) \cdot R(t), \,\,
\forall p \in P\], denoted by $M [ R \rangle M'$.
\end{enumerate}
\end{definition}

\begin{definition} Let $N=(P,T,F,K,W,M_0)$ be a marked Petri net.
\begin{enumerate}
\item $\sigma = M_0 t_1 M_1 \ldots t_n M_n$ is a finite occurrence sequence of $N$
if and only if $\forall i \in \{1,\ldots,n\},\,M_{i-1} [ t_i \rangle M_i$.
Occasionally, we will write $t_1 \ldots t_n$, ommiting the corresponding markings, since starting from
$M_0$ it is easy to obtain the rest of the markings knowing the transitions fired.
We extend the conventional notation to occurrence sequence, 
obtaining $M_0 [ \sigma \rangle M_n$.
The set of occurrence sequences starting from $M_0$ are denoted by $L(N,M_0)$.

\item An ocurrence sequence $\sigma = M_0 R_1 M_1 \ldots R_n M_n$ is finite
iff $\forall i \in \{1,\ldots,n\},\,M_{i-1} [ R_i \rangle M_i$.
Again, we extend the notation to ocurrence sequence, $M_0 [ \sigma \rangle M_n$.
The set of ocurrence sequence of $N$ starting from $M_0$ is denoted by $P(N,M_0)$.
\end{enumerate}
\end{definition}

%En lo sucesivo trabajaremos usualmente sobre la sem\'{a}ntica de
%secuencias de ocurrencia, salvo que expl\'{\i}citamente se
%indique lo contrario.

%\bdfn (Matrices de Incidencia)\\
%Sea $N=(P,T,F,W,M_0)$ una Red de Petri Marcada.
%\begin{enumerate}
%\item Se dice que $N$ es {\it pura} sii $\forall t \in T$,
%$\forall p \in P$, $W(t,p) \cdot W(p,t) = 0$.
%\item Si $N$ es una red pura, podemos definir su
%{\it matriz de incidencia previa}, $C^{-} = (c_{i,j}^{-})$,
%$i=1,\ldots,|P|\,;\,j=1,\ldots,|T|$, siendo
%$c_{i,j}^{-} = W(p_i,t_j)$, y su
%{\it matriz de incidencia posterior}
%$C^{+} = (c_{i,j}^{+})$,
%$i=1,\ldots,|P|\,;\,j=1,\ldots,|T|$, siendo
%$c_{i,j}^{+} = W(t_i,p_j)$.
%\item Si $N$ es una red pura se define su {\it matriz de
%incidencia} $C$ por medio de $C = C^+ - C^-$.
%\end{enumerate}
%\edfn

%La matriz de incidencia puede ser definida tambi\'{e}n sobre redes
%que no sean puras, pero en tal caso no caracteriza a las mismas, pues
%una misma matriz de incidencia corresponde a varias redes diferentes.
%
%\bex Es sencillo obtener dos Redes de Petri diferentes con la misma
%matriz de incidencia. Para ello basta tomar
%una Red de Petri Ordinaria y elegir un lugar y una transici\'{o}n
%no conectados inicialmente, y conectarlos formando un loop. Por
%ejemplo, las dos redes de la figura \ref{fig203} tienen la misma
%matriz de incidencia. De hecho, si se trabaja con Redes Generalizadas
%el a\~{n}adido se puede hacer sobre cualquier par.
%\eex
%
%\begin{figure}
%\input{fig28}
%\caption{\label{fig203} Dos Redes de Petri con la misma Matriz de Incidencia}
%\end{figure}

%\bprop (Ecuaci\'{o}n de Estado)\\
%Sea $N=(P,T,F,W,M_0)$ una Red de Petri Marcada Pura,
%$\sigma \in L(N,M_0)$, y $M_0 [ \sigma \rangle M$.
%Entonces se tiene: $M = M_0 + C \cdot \bar{\sigma}$, siendo
%$\bar{\sigma}$ el vector de Parikh asociado a la
%secuencia $\sigma$, que est\'{a} definido como
%$\bar{\sigma}(i) = $n\'{u}mero de ocurrencias de
%la transici\'{o}n $t_i$ en la secuencia $\sigma$.
%
%\proof Sea la secuencia de marcajes producida a lo
%largo de la ejecuci\'{o}n de $\sigma$: $M_0 t_{i_{1}} M_1 \ldots t_{i_{n}} M_n$.
%Entonces, de la regla de disparo se concluye que $M_1 = M_0 +
%C \cdot U_{i_{1}}$, siendo $U_{i_{1}}$ el vector cuyas componentes son todas
%nulas, salvo la $i_{1}$-\'{e}sima, que vale 1. En general, se obtiene
%que $M_k = M_{k-1} + C \cdot U_{i_{k}}$.
%
%Por tanto:
%\[ M_k = M_{k-2} + C \cdot (U_{i_{k-1}} + U_{i_{k}}) = \ldots =
%M_0 + C \cdot \sum_{j=1}^{k} U_{i_{j}}\]
%Ahora bien, $\suma{j=1}{k} U_{i_{j}} = \bar{\sigma}$, lo que
%termina la demostraci\'{o}n.
%\eprop

\section{Petri nets analysis}
When designing a new system, the construction of a graphical model of it is always
helpful since it is interesting to broadly understand how this system works, helping designers to have a
deeper knowledge about it. Nevertheless, the presence of a graphical model is not enough in many cases
as the designers want the system to meet some properties of interest. For instance, the system is useless
if it reaches a dealock in each execution.  To this end, it is important to have tools that allow to
evaluate properties in the model. In finite sequential systems, it is not particularly challeging to check
the fulfillment of certain statement, whereas the presence of concurrency complicates this task.
The analysis of systems behaviour is intened to determe the compliance of 
certain properties such as the number of processes in a queue does not exceed
certain threshold or that the mutual exclusion is guaranteed when accessing to a shared resource.

In Petri nets , there is a set of powerful tools to formally analyse
the compliance of such properties. For instance, these properties check
the absence of deadlocks, the reachability of a certain
state, the possibility of reaching the situation after performing some computations and so on.


\medskip
Normally, these properties are divided in two categories \cite{citar}:

\subsection{Safety properties}
A safety property asserts that \emph{``nothing bad happens''}.
Thus, they guarantee that a set of undesirable states are not reached or that
the system does not execute an unwanted ocurrence sequence.

The safety properties are the following:

\begin{enumerate}
\item {\bf Reachability}. A marking $M$ of a marked Petri net
$N= (P,T,F,W,M_0)$ is {\it reachable} in $N$
iff there exists an ocurrence sequence $\sigma \in L(N,M_0)$
such that $M_0 [ \sigma \rangle M$. We will denote by $[M_0\rangle$ the
set of reachable markings of $N$ starting from $M_0$, and
by $[ M \rangle$ the set of reachable markings starting from the marking $M$

\item {\bf Boundedness}. A marked Petri net $N=(P,T,F,W,$ \linebreak
$M_0)$ is {\it k-bounded}, for some $k \in \nnul$, if all reachable marking
$M$ from $M_0$ hold that $M(p) \leq k$, for all $p \in P$. $N$ is safe if
it is 1-bounded. A place $p \in P$ is
{\it n-safe} if $M(p) \leq k$, for all markings $M$ reachable from $M_0$.

%\item {\bf Boundedness}. Sea
%$N=(P,T,F,W,M_0)$ una Red de Petri Marcada.
%Se dice que un lugar $p \in P$ es limitado si
%existe un n\'{u}mero natural $n \in \nnul$ tal que dicho lugar es
%$n$-seguro; y se dice que $N$ es {\it limitada} si todos sus lugares
%son limitados.
\item {\bf Deadlock-free}. Let $N=(P,T,F,W,$ \linebreak
$M_0)$ a marked Petri net and $M$ be a reachable marking from $M_0$.
$M$ is a {\it dead marking} if there is no $t \in T$ that is enabled in $M$. 
The net $N$ is dealock-free iff there are no dead markings.

%\item {\bf Conservaci\'{o}n Respecto a un Vector de Pesos}.
%Sea una Red de Petri Marcada $N=(P,T,F,W,M_0)$, con
%$P = \{p_1,\ldots,p_n\}$. Se dice que $N$ es
%{\it conservativa respecto a un vector de pesos w}, con
%$w \in \nnul^n$, si para todo marcaje alcanzable $M$
%a partir de $M_0$ se cumple:
%\[ \suma{i=1}{n} w_i \cdot M(p_i) =
%\suma{i=1}{n} w_i \cdot M_0(p_i)\]
\item {\bf Coverability}.
Let $N=(P,T,F,W,M_0)$ be a marked Petri net and $M$ be a marking of $N$.
$M$ is said to be {\it coverable} if there exists $M' \in
[M_0 \rangle$ such that $M' \geq M$.
\end{enumerate}

%\noindent {\sc NOTA:} Para ser m\'{a}s precisos, la alcanzabilidad no es
%exactamente una propiedad de seguridad, sino la negaci\'{o}n de la propiedad,
%la no alcanzabilidad. An\'{a}logamente ocurre con el cubrimiento de marcajes.

\subsection{Liveness properties}

Garantizan que el sistema, con independencia de su estado actual,
podr\'{a} eventualmente alcanzar un determinado estado de un cierto conjunto
de estados, o podr\'{a} eventualmente ejecutar una cierta secuencia de eventos.
Son propiedades de actividad las siguientes:
\begin{enumerate}
\item {\bf Liveness}.
Sea $N=(P,T,F,W,M_0)$ una Red de Petri Marcada. Una transici\'{o}n $t \in T$
se dice que es {\it viva} si para todo marcaje alcanzable $M \in
[ M_0 \rangle$ existe una secuencia de ocurrencia $\sigma$ que parte
de $M$ tal que $\sigma = t_1 \ldots t_m$, con $t_m = t$. Se dice que
$N$ es {\it viva} si todas sus transiciones son vivas.
\item {\bf Home State}.
Sea $N=(P,T,F,W,M_0)$ una Red de Petri Marcada. Se dice que
un marcaje $M$ de $N$ es un {\it home state} si para todo
$M' \in [ M_0 \rangle$ se tiene $M \in [ M' \rangle$.
\item {\bf Home Space}. Sea $N=(P,T,F,W,M_0)$ una Red de Petri Marcada.
Se dice que un conjunto de marcajes ${\cal M}$ es un {\it home-space}
de $N$ si para todo marcaje $M' \in [ M_0 \rangle$ existe un marcaje
$M'' \in {\cal M}$ tal que $M'' \in [ M' \rangle$.
\item {\bf Cyclic}.
Sea $N=(P,T,F,W,M_0)$ una Red de Petri Marcada. Se dice que
$N$ tiene un {\it comportamiento c\'{\i}clico} si para todo marcaje
$M \in [ M_0 \rangle$ existe una secuencia de ocurrencia $\sigma$
que parte de $M$ tal que $M [ \sigma \rangle M_0$.
\end{enumerate}


% % %JIRI % % % %
Let $\nnul = \mathbb{N} \cup \{0\}$ and 
$\nnul^{\infty} = \nnul \cup \left\{\infty \right\}$.
A \emph{discrete timed transition system} (DTTS) 
is a triple $\left(\proc, \act,\rightarrow\right)$
where $\proc$ is the set of states, $\act$ is the set of actions
and $\rightarrow\: \subseteq \proc \times (\act \cup \nnul)  \times \proc$ is the 
transition relation written as $s \trans{a} s'$ whenever $(s,a,s') \in \rightarrow$.
If $a \in \act$ then we call it a \emph{switch transition}, if
$a \in \nnul$ we call it a \emph{delay transition}.
%By $\rightarrow^{*}$ we denote the reflexive and transitive closure of 
%the relation
%$\rightarrow  \eqdef \bigcup_{a \in \act} \trans{a} \; \cup \; \bigcup_{d \in \nnul} \trans{d}$. 
We also define the set of \emph{well-formed time intervals} as 
$\int \eqdef \{[a,b] \mid a \in \nnul,b\in \nnul^{\infty}, a\leq b \}$
and its subset $\intinv \eqdef \{[0,b] \mid b\in \nnul^{\infty} \}$
used in age invariants. 

\section{Timed extensions of Petri nets}

Hablar de las redes de Merlin y luego introducir las nuestras

\begin{definition}[timed-Arc Petri Net] \label{defetapn}  
An \emph{extended timed-arc Petri net} 
(ETAPN) is a 9-tuple $N = \tapntuple$ where 
\begin{itemize}
\item $P$ is a finite set of \emph{places},
\item $T$ is a finite set of \emph{transitions} 
such that $P \cap T = \emptyset$, 
\item $\Turg \subseteq T$ is the set of \emph{urgent transitions},
\item $\ia \subseteq P \times T$ is a finite set of \emph{input arcs},
\item $\oa \subseteq T \times P$ is a finite set of \emph{output arcs},
\item $\cfunction : \ia \rightarrow \int$ is a \emph{time constraint function} assigning 
guards %(time intervals) 
to input arcs,
\item $\wfunction : \ia\cup \oa \rightarrow \mathbb{N}$ is a function assigning \emph{weights} to input and output arcs,
\item $\type : \ia \cup \oa \rightarrow \types$ is a \emph{type function} assigning a type to all arcs where $\types = \{\normal, \inhib\} \cup \{\transporti \mid j \in \mathbb{N} \}$ such that  
\begin{itemize}
\item if $\type(a) = \inhib$ then $a \in \ia$ and $\cfunction(a)=[0,\infty]$, 
\item if $(p,t) \in \ia$ and $t \in \Turg$ then $\cfunction((p,t))=[0,\infty]$,
\item if $\type((p,t)) = \transporti$ for some $(p,t) \in \ia$ then there is exactly one $(t,p^{\prime}) \in \oa$ such that $\type((t,p^{\prime})) = 
\transporti$, 
%and moreover $\wfunction((p,t))=\wfunction((t,p^{\prime}))$,
\item if $\type((t,p^{\prime})) = \transporti$ for some $(t,p^{\prime}) \in \oa$ then there is exactly one $(p,t) \in \ia$ such that $\type((p,t)) = 
\transporti$, 
%and moreover $\wfunction((p,t))=\wfunction((t,p^{\prime}))$,
\item if $\type((p,t)) = \transporti = \type((t,p^{\prime}))$ 
then $\wfunction((p,t))=\wfunction((t,p^{\prime}))$,
\end{itemize}
\item $\inv : P \rightarrow \int^{inv}$ is a function assigning \emph{age invariants} to places.
\end{itemize}
\end{definition}

%\begin{remark}
Note that for transport arcs we assume that they come in pairs (for
each type $\transporti$) so that their weights match.
Also for inhibitor arcs and for input arcs to urgent transitions, we
require that the guards are $[0,\infty]$. This restriction is important
for some of the results presented in this paper and it also guarantees that 
we can use DBM-based algorithms in the tool TAPAAL~\cite{DJJJMS:TACAS:12}.
%\end{remark}

The ETAPN model is not monotonic, meaning
that adding more tokens to markings can disable time delays or
transition firing.
Therefore we define a subclass of 
ETAPN where the monotonicity breaking features are not allowed.
In the literature such nets are often considered as the standard
timed-arc Petri net model~\cite{BLT:90,Hanisch:93} but we add the 
prefix monotonic for clarity reasons. 

\begin{definition}[Monotonic timed-arc Petri net] \label{deftapn}
A \emph{monotonic timed-arc Petri net} 
(MTAPN) is an extended timed arc Petri net 
with no urgent transitions ($\Turg=\emptyset)$, no age invariants
($\inv(p) = [0,\infty]$ for all $p \in P$) and no 
inhibitor arcs ($\type(a) \not= \inhib$ for all $a \in \ia$).
\end{definition}


%Let $N = \tapntuple$ be a ETAPN and $P^\prime \subseteq P$, the projection $N|_{P^\prime}$ 
%is the net \ensuremath{(P^\prime, T, \ia^\prime,\allowbreak \oa^\prime, \cfunction^\prime, 
%\wfunction^\prime, \type^\prime, \inv^\prime)}, 
%where $\ia^\prime=\ia \cap (P^\prime \times T)$, $\oa^\prime=\oa \cap (T \times P^\prime)$,
%$\cfunction^\prime : \ia^\prime \rightarrow \int$, $\wfunction^\prime : \ia^\prime \cup \oa^\prime \rightarrow \mathbb{N}$,
%$\type^\prime : \ia^\prime \cup \oa^\prime \rightarrow \types$, and $\inv^\prime : P^\prime \rightarrow \int^{inv}$. From now on, we will denote by 
%$P_s$ the set of places shared by various nets. Then, let $N$, $N^\prime$ be two ETAPNs such that $P \cap P^\prime \subseteq P_s$, the disjoint union of $N$ and $N^\prime$ is a ETAPN \ensuremath{(P^{\prime\prime},T^{\prime\prime},\ia^{\prime\prime}, \oa^{\prime\prime},\cfunction^{\prime\prime},\wfunction^{\prime\prime},\type^{\prime\prime}, \inv^{\prime\prime})}, where $P^{\prime\prime}= P\cupdot P^\prime, T^{\prime\prime}=T\cupdot T^\prime, \ia^{\prime\prime}=\ia\cupdot \ia^\prime,\oa^{\prime\prime}=\oa \cupdot \oa^\prime,\cfunction^{\prime\prime}:\ia^{\prime\prime}\cup \oa^{\prime\prime}\rightarrow \int, \wfunction^{\prime\prime}: \ia^{\prime\prime}\cup \oa^{\prime\prime}\rightarrow \mathbb{N}, 
%\type^{\prime\prime} : \ia^{\prime\prime} \cup \oa^{\prime\prime} \rightarrow \types, \text{ and } \inv^{\prime\prime} : P^{\prime\prime} \rightarrow \int^{inv}$.

Before we give the formal semantics of the model, let us fix some notation.
Let $N = \tapntuple$ be an ETAPN. 
%Let $F\eqdef \ia \cup \oa$. 
We denote by ${}^\bullet x \eqdef 
\{y \in P \cup T \mid (y,x) \in (\ia \cup \oa),\ \type((y,x)) \neq \inhib \}$ 
the preset of a transition or a place $x$.
Similarly, the postset $x^\bullet$ is defined as 
$x^\bullet \eqdef \{y \in P \cup T \mid (x,y) \in (\ia \cup \oa) \}$.
Let $\mathcal{B}(\nnul)$ be the set 
of all finite multisets over $\nnul$. A \emph{marking} $M$ on $N$ 
is a function $M : P \longrightarrow \mathcal{B}(\nnul)$ 
where for every place $p \in P$ and 
every token $x \in M(p)$ we have $x \in \inv(p)$, in other words
all tokens have to satisfy the age invariants. 
%The projection of $P^\prime \subseteq P$ in $M$ is a function 
%$M|_{P^\prime} : P^\prime \longrightarrow \mathcal{B}(\nnul)$.
The set of all markings in a net $N$ 
is denoted by $\mathcal{M}(N)$.

We write $(p,x)$ to denote a token at a place $p$ with the 
age $x\in \nnul$. Then $M=\{(p_1,x_1),(p_2,x_2),\dots ,(p_n,x_n)\}$ 
is a multiset representing a marking $M$ with $n$ tokens of 
ages $x_i$ in places $p_i$. We 
define the size of a marking as $|M| = \sum_{p\in P}|M(p)|$ where 
$|M(p)|$ is the number of tokens located in the place $p$.

%A marked ETAPN 
%$(N,M_0)$ is a TAPN N together with an initial marking $M_0$ with all tokens of age $0$. 

\begin{definition}[Enabledness]
\label{def:enabledness}
 Let $N = \tapntuple$ be an ETAPN. 
We say that a transition $t \in T$ is \emph{enabled} in a marking $M$ by the 
multisets of tokens
$\inn = \{(p,x_{p}^1), (p,x_{p}^2), \dots ,(p,x_{p}^{\wfunction ((p,t))})\mid 
p \in {}^\bullet t\} \subseteq M$ and 
$\out = \{ (p^{\prime},x_{p^{\prime}}^1),
           (p^{\prime},x_{p^{\prime}}^2),
\dots ,\allowbreak
(p^{\prime},x_{p^{\prime}}^{\wfunction ((t,p^{\prime}))}) 
\mid p^{\prime} \in t^\bullet \}$ if
\begin{itemize}
\item for all input arcs except the inhibitor arcs, the tokens from $\inn$ satisfy the age guards of the arcs, i.e. 
%$$\forall(p,t) \in \ia, x_p^i \in \cfunction((p,t))\text{ for }1\leq i\leq w((p,t)) $$ 
$$\forall(p,t) \in \ia. \type((p,t)) \neq \inhib \Rightarrow  x_p^i \in \cfunction((p,t))\text{ for }1\leq i\leq w((p,t)) $$ 
%\item for each place $p$ in ${}^\bullet t$ there are $\wfunction ((p,t))$ tokens from $p$ in $\inn$, i.e. $$\forall p\in {}^\bullet t. \wfunction ((p,t))= n_{p} $$
%\item for each place $p^{\prime}$ in $t^\bullet $ there are $\wfunction ((t,p^{\prime}))$ tokens from $p^{\prime}$ in $\out$, i.e. $$\forall p^{\prime}\in t^\bullet . \wfunction ((t,p^{\prime}))= m_{p^{\prime}} $$
\item for any inhibitor arc pointing from a place $p$ to the
transition $t$, the number of tokens in $p$ is smaller than the weight of the arc, i.e.
$$\forall(p,t) \in \ia. \type((p,t)) = \inhib \Rightarrow|M(p)|<\wfunction ((p,t))$$ 
%$$\forall(p,t) \in \ia. \type((p,t)) = \inhib \Rightarrow \nexists x \in M(p). x \in \cfunction((p,t))$$
\item for all input arcs and output arcs which constitute a transport arc, 
the age of the input token must be equal to the age of the output token and satisfy the invariant of the output place, i.e.
\begin{eqnarray*}
&\forall(p,t) \in \ia. \forall(t,p^{\prime}) \in \oa.\type((p,t)) = \type((t,p^{\prime})) 
= \transporti \\
&\Rightarrow \big( x_p^i = x_{p^{\prime}}^i \wedge x_{p^{\prime}}^i \in 
\inv(p^{\prime})\big) \text{ for } 1\leq i \leq w((p,t))
\end{eqnarray*}
\item for all normal output arcs, the age of the output token is $0$, i.e. $$\forall(t,p^{\prime}) \in \oa. \type((t,p^{\prime})) = \normal \Rightarrow x_{p^{\prime}}^i = 0 \text{ for }1\leq i \leq w((p,t)).$$ 
\end{itemize}
\end{definition}

A given ETAPN $N$ %=\tapntuple$ 
defines a DTTS $T(N)\eqdef (\markingsof(N),T,\rightarrow)$
where states are the markings and the transitions are as follows. 
\begin{itemize}
\item If $t\in T$ is enabled in a marking $M$ by the  multisets of
tokens $\inn$ and $\out$ then $t$ can \emph{fire} and produce 
the marking $M^{\prime} = (M \smallsetminus \inn) \uplus \out$ 
where  $\uplus$ is the multiset sum operator and $\smallsetminus$ is the multiset 
difference operator; we write $M \trans{t} M^{\prime}$ for this 
switch transition.
\item A time \emph{delay} $d \in \nnul$ is allowed in $M$ if
\begin{itemize}
\item $(x+d) \in I(p)$ for all $p \in P$ and all $x \in M(p)$, and
% i.e. by delaying $d$ time units no token violates any of the age invariants, 
%and
\item if $M \trans{t} M'$ for some $t \in \Turg$ then $d=0$.
 %there is at least one urgent transition enabled in $M$ then
 %     $d=0$, i.e. enabled urgent transitions disallow time passing.
\end{itemize}
By delaying $d$ time units in $M$ we reach the marking $M^{\prime}$ defined as
$M^{\prime}(p) = \{x+d \mid x \in M(p)\}$ for all $p \in P$; 
we write $M \trans{d} M^{\prime}$ for this delay transition.
\end{itemize}

A computation of a net $N$ from the initial marking $M_0$ is
$M_0 \rightarrow M_1\rightarrow \cdots \rightarrow M_n$ is 
denoted by $\{M_i\}_{i=0}^{n}$ 
and we call it a \emph{run}. If the sequence is infinite, we write 
$\{M_i\}_{i\geq 0}$. Moreover, we write $M \Rightarrow^* M^{\prime}$ if  
$M^{\prime}$ is reachable from $M$ and $[M\rangle$ represents the set of reachable markings of $M$.

\noindent Let 
$\trans{} \eqdef \bigcup_{t \in T} \trans{t} \cup \bigcup_{d \in \nnul} \trans{d}$.
The set of all markings reachable %in the net $N$ 
from a given marking $M$ is denoted by 
$[M\rangle \eqdef \{ M' \mid M \trans{}^* M' \}$.
By $M \trans{d,t} M'$ we denote that there is a marking $M''$
such that $M \trans{d} M'' \trans{t} M'$.

A marking $M$ is a \emph{deadlock} if there is no $d \in \nnul$ and
no $t \in T$ such that $M \trans{d,t} M'$ 
for some marking $M'$.
A marking $M$ is \emph{divergent} if for any $d \in \nnul$
we have $M \trans{d} M'$ for some $M'$.


%\section{Finite Abstractions for Bounded ETAPNs}

In general, ETAPNs are infinite in two dimensions. The number of tokens
in reachable markings can be unbounded and even for bounded nets
the ages of tokens can be arbitrarily large. We shall now recall a 
few results that allow us to make finite abstractions for bounded
ETAPNs, i.e. for nets where the maximum number of tokens in any
reachable marking is bounded by a constant.

Let $N=\tapntuple$ be a given ETAPN.
In~\cite{ALSST:MEMICS:12} 
the authors provide an algorithm for computing 
a function $\cmax: P \rightarrow (\nnul \cup \{ -1 \})$ 
returning for each place $p \in P$ the maximum constant associated
to this place, meaning that the ages of tokens in place $p$ that
are strictly greater than $\cmax(p)$ are irrelevant. In particular,
places where $\cmax(p)=-1$ are the so-called \emph{untimed} places
where the age of tokens is not relevant at all, implying that all
the intervals on their ongoing arcs are $[0,\infty]$.

Let $M$ be a marking of $N$. We split it into 
two markings $\mold$ and $\myoung$ where 
$\mold (p)=\left\{ x\in M(p) \mid x>\cmax(p) \right\}$ 
and $\myoung (p)=\allowbreak\left\{ x\in M(p) \mid 
x\allowbreak\leq\allowbreak \cmax(p) \right\}$
for all places $p \in P$. Clearly,
$M = \mold \uplus \myoung$.

We say that two markings $M$ and $M'$ in the net $N$ are equivalent, 
written $M \eqMarking M^{\prime}$, 
if $\myoung=\myoung^{\prime}$
and for all $p \in P$ we have
$|\mold (p)|=|\mold^{\prime}(p)|$.
In other words $M$ and $M'$ agree on the tokens with ages below the
maximum constants and have the same number of tokens above the maximum
constant.
% (relevant only for places $p$ with $I(p)=[0,\infty]$ as
%places with nontrivial age invariants cannot have tokens older that 
%the maximum constant which is in this case equal to the invariant upper-bound).

The relation $\eqMarking$ is an equivalence relation and it is
also a timed bisimulation 
where delays and transition firings on one side can be matched by
exactly the same delays and transition firings on the other side
and vice versa. % (see e.g.~\cite{LY:97}).

\begin{theorem}[\cite{ALSST:MEMICS:12}]
\label{thm:bisim}
  The relation $\eqMarking$ is a timed bisimulation.
\end{theorem}

We can now define canonical representatives for each
equivalence class of $\eqMarking$. 

\begin{definition}[Cut]
\label{def:cut}
Let $M$ be a marking.
We define its canonical marking $\cut(M)$ by 
$\cut(M)(p)= \myoung(p)\uplus \big\{ \underbrace{ \cmax(p)+1,\dots ,\cmax(p)+1 }_{|\mold(p)| \text{ times}} \big\}$.
%\begin{equation*}
%  \cut(M)(p)=
%\begin{cases}
%\myoung(p)  \quad \text{if $p$ is invariant or dead-token place,} \\
%\myoung(p)\uplus \big\{ \underbrace{ \cmax(p)+1,\dots ,\cmax(p)+1 }_{|\mold(p)| \text{ times}} \big\}    \quad \text{if $p$ is a normal place.}
%\vspace{-.45cm}
%\end{cases}
%\vspace{.45cm}
%\end{equation*}
\end{definition}

\begin{lemma}[\cite{ALSST:MEMICS:12}]
\label{lemma:canon}
Let $M$, $M_1$ and $M_2$ be markings. Then
(i) $M \eqMarking \cut(M)$, and (ii)
$M_1 \eqMarking M_2$ if and only if $\cut(M_1)=\cut(M_2)$.
\end{lemma}

Let $M$ and $M^\prime$ be two markings. We say that $M^\prime$ \emph{covers} 
$M$, denoted by $M \sqsubseteq M^\prime$, if $M(p) \subseteq M^\prime(p)$ 
for all $p \in P$. We write $M \sqsubseteq_{cut} M^\prime$ 
if $cut(M) \sqsubseteq cut(M^\prime)$.

For monotonic timed-arc Petri nets we can now show that adding more tokens
to the net does not restrict its possible behaviour. 

\begin{lemma}
\label{lem:mono}
Let $N$ be an MTAPN and $M,M' \in \mathcal{M}(N)$
be two of its markings such that $M \sqsubseteq_{\cut} M'$. 
If $M \trans{d} M_1$ (resp. $M \trans{t} M_1$) then 
$M' \trans{d} M'_1$ (resp. $M' \trans{t} M'_1$) such that 
$M_1 \sqsubseteq_{cut} M'_1$ and 
$|M'|-|M|=|M'_1|-|M_1|$.
\end{lemma}
\begin{proof}
Let $M \trans{d} M_1$, resp. $M \trans{t} M_1$.
As $M \equiv \cut(M)$ by Lemma~\ref{lemma:canon}(i),
we can by Theorem~\ref{thm:bisim} conclude that also $\cut(M) \trans{d} M_2$,
resp. $\cut(M) \trans{t} M_2$,
such that $M_1 \equiv M_2$. Recall that $\cut(M) \sqsubseteq \cut(M')$
by the assumption of the lemma.
\begin{itemize}
\item Time delay case ($\cut(M) \trans{d} M_2$).
As the net does not contain any nontrivial age invariants
and there are no urgent transitions,
we know that also $\cut(M') \trans{d} M_3$ such that
$M_2 \sqsubseteq M_3$ as time delay preserves the $\sqsubseteq$-relation.
\item Transition firing case ($\cut(M) \trans{t} M_2$).
As the net does not have any inhibitor arcs,
we can see that also $\cut(M') \trans{t} M_3$ by consuming
exactly the same tokens in $\cut(M')$ as we did in $\cut(M)$.
Clearly, $M_2 \sqsubseteq M_3$.
\end{itemize}
Because $\cut(M') \equiv M'$ due to Lemma~\ref{lemma:canon}(i),
we know by Theorem~\ref{thm:bisim}
that $M' \trans{d} M'_1$, resp. $M' \trans{t} M'_1$, such that $M_3 \equiv M'_1$.
Hence $M_1 \equiv M_2 \sqsubseteq M_3 \equiv M'_1$.
By Lemma~\ref{lemma:canon}(ii) we get
$\cut(M_1)=\cut(M_2)$ and $\cut(M_3)=\cut(M'_1)$.
Observe now a simple fact that $M_2 \sqsubseteq M_3$ implies that
$\cut(M_2) \sqsubseteq \cut(M_3)$.
This all together implies that $\cut(M_1)=\cut(M_2) \sqsubseteq
\cut(M_3) = \cut(M'_1)$ which is another way of saying that
$M_1 \sqsubseteq_\cut M'_1$ as required by the lemma.
As time delays do not change the number of
tokens in $M$ and $M'$ and transition firing adds or removes an
equal number of tokens from both $M$ and $M'$,
we can also conclude that $|M'|-|M|=|M'_1|-|M_1|$.
\qed
\end{proof}





